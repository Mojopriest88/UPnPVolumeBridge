name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Create plugin directory structure
        run: |
          mkdir -p build/UPnPVolumeBridge
          cp -r lib build/UPnPVolumeBridge/
          cp strings.txt build/UPnPVolumeBridge/
          cp install.xml build/UPnPVolumeBridge/
          cp -r HTML build/UPnPVolumeBridge/
          cp LICENSE build/UPnPVolumeBridge/
          ls -la build/UPnPVolumeBridge/
      
      - name: Create zip archive
        run: |
          cd build
          zip -r ../UPnPVolumeBridge.zip UPnPVolumeBridge/
          ls -lh ../UPnPVolumeBridge.zip
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: UPnPVolumeBridge.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update repo.xml
        run: |
          # Checkout main branch to avoid detached HEAD
          git checkout main
          
          # Calculate SHA1
          SHA=$(sha1sum UPnPVolumeBridge.zip | awk '{print $1}')
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # Update repo.xml using more specific sed patterns
          # Update version only in the <plugin> tag
          sed -i "s/\(<plugin.*\)version=\"[^\"]*\"/\1version=\"$VERSION\"/" repo.xml
          
          # Update or Insert SHA tag before </plugin>
          if grep -q "<sha>" repo.xml; then
            sed -i "s|<sha>.*</sha>|<sha>$SHA</sha>|" repo.xml
          else
            sed -i "s|</plugin>|  <sha>$SHA</sha>\n    </plugin>|" repo.xml
          fi
          
          # Update download URL
          sed -i "s|/v[0-9.]*/UPnPVolumeBridge.zip|/v$VERSION/UPnPVolumeBridge.zip|" repo.xml
          
          # Commit and Push
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add repo.xml
          git commit -m "Update repo.xml for version $VERSION"
          git push origin main

